import*as d from"https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js";import{feature as ee}from"https://cdn.jsdelivr.net/npm/topojson-client@3/+esm";import*as B from"https://cdn.jsdelivr.net/npm/d3-geo@3/+esm";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function r(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=r(n);fetch(n.href,a)}})();const _="./india_subdivisions.topo.json",te="./RainfallDataClean.csv",E=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"],S="YEAR",ne=document.getElementById("app")||document.body,x=new d.WebGLRenderer({antialias:!0,alpha:!0});x.setClearColor(723723,1);x.setPixelRatio(Math.min(window.devicePixelRatio||1,2));ne.appendChild(x.domElement);const D=new d.Scene;let h;const T=new d.Group;D.add(T);const P=new d.Group;P.position.z=1;D.add(P);let w=null,k=null,V=new Map,M=new Map,U=[],p=[],g=[],A=0,O=0,oe=1200,W=0;const o=e=>(e??"").toLowerCase().replace(/\s+/g," ").replace(/[^\w& ]/g,"").trim(),G={[o("Andaman & Nicobar Islands")]:o("1"),[o("Arunachal Pradesh")]:o("2"),[o("Assam & Meghalaya")]:o("3"),[o("Naga Mani Mizo Tripura")]:o("4"),[o("Sub Himalayan West Bengal & Sikkim")]:o("5"),[o("Gangetic West Bengal")]:o("6"),[o("Orissa")]:o("7"),[o("Jharkhand")]:o("8"),[o("Bihar")]:o("9"),[o("East Uttar Pradesh")]:o("10"),[o("West Uttar Pradesh")]:o("11"),[o("Uttarakhand")]:o("12"),[o("Haryana Delhi & Chandigarh")]:o("13"),[o("Punjab")]:o("14"),[o("Himachal Pradesh")]:o("15"),[o("Jammu & Kashmir")]:o("16"),[o("West Rajasthan")]:o("17"),[o("East Rajasthan")]:o("18"),[o("West Madhya Pradesh")]:o("19"),[o("East Madhya Pradesh")]:o("20"),[o("Gujarat Region")]:o("21"),[o("Saurashtra & Kutch")]:o("22"),[o("Konkan & Goa")]:o("23"),[o("Madhya Maharashtra")]:o("24"),[o("Matathwada")]:o("25"),[o("Vidarbha")]:o("26"),[o("Chhattisgarh")]:o("27"),[o("Coastal Andhra Pradesh")]:o("28"),[o("Telangana")]:o("29"),[o("Rayalseema")]:o("30"),[o("Tamil Nadu")]:o("31"),[o("Coastal Karnataka")]:o("32"),[o("North Interior Karnataka")]:o("33"),[o("South Interior Karnataka")]:o("34"),[o("Kerala")]:o("35"),[o("Lakshadweep")]:o("36")},Y={};new Map(Object.entries(Y).map(([e,t])=>[o(e),t]));const K=new Map,re=.25,se=Object.fromEntries(Object.entries(G).map(([e,t])=>[t,e]));async function ae(e){const t=await fetch(e);if(!t.ok)throw new Error("Failed to load "+e+" ("+t.status+")");const r=await t.json();if(r.type==="Topology"){const s=Object.keys(r.objects)[0];return ee(r,r.objects[s])}if(r.type==="FeatureCollection")return r;throw new Error("Unrecognized data type: "+r.type)}async function ie(e){const r=(await(await fetch(e)).text()).split(/\r?\n/).filter(Boolean),s=r[0].split(",").map(a=>a.trim()),n=[];for(let a=1;a<r.length;a++){const c=ce(r[a]);if(c.length!==s.length)continue;const f={};for(let i=0;i<s.length;i++)f[s[i]]=c[i];n.push(f)}return n}function ce(e){return e.split(",").map(t=>t.trim())}function le(e,t,r,s){const n=[];function a(i){const[u,l]=t(i);return{x:u-r/2,y:-l+s/2}}function c(i){if(!i||i.length<2)return;const u=a(i[0]);let l=u;for(let m=1;m<i.length;m++){const y=a(i[m]);n.push(l.x,l.y,0,y.x,y.y,0),l=y}n.push(l.x,l.y,0,u.x,u.y,0)}for(const i of e.features){const u=i.geometry;if(u){if(u.type==="Polygon")for(const l of u.coordinates)c(l);else if(u.type==="MultiPolygon")for(const l of u.coordinates)for(const m of l)c(m)}}const f=new d.BufferGeometry;return f.setAttribute("position",new d.Float32BufferAttribute(new Float32Array(n),3)),f}function ue(e){const t=new d.LineBasicMaterial({color:16777215,transparent:!0,opacity:.35});return new d.LineSegments(e,t)}function J(e={}){return e.SUBDIVISION||e["SUB-DIV"]||e.MET_SUBDIV||e.DIVISION||e.NAME_1||e.NAME||e.name||e.subdivisio||""}function fe(e,t,r,s){const n=new d.Group,a=B.geoPath(t);for(const c of e.features){const f=J(c.properties);if(!f)continue;const[i,u]=a.centroid(c),l=new d.Vector3(i-r/2,-u+s/2,0),m=de(f);m.position.copy(l),n.add(m)}return n}function de(e,{fontSize:t=14,pad:r=4}={}){const s=Math.min(window.devicePixelRatio||1,2),n=document.createElement("canvas").getContext("2d");n.font=`${t}px system-ui, -apple-system, Segoe UI, Roboto, sans-serif`;const a=Math.ceil(n.measureText(e).width)+r*2,c=t+r*2+2,f=document.createElement("canvas");f.width=Math.max(1,Math.floor(a*s)),f.height=Math.max(1,Math.floor(c*s));const i=f.getContext("2d");i.setTransform(s,0,0,s,0,0),i.font=n.font,i.textBaseline="top",i.fillStyle="rgba(0,0,0,0.55)",i.fillRect(0,0,a,c),i.fillStyle="#e9eef6",i.fillText(e,r,r);const u=new d.CanvasTexture(f);u.minFilter=d.LinearFilter,u.magFilter=d.LinearFilter,u.generateMipmaps=!1,u.needsUpdate=!0;const l=new d.SpriteMaterial({map:u,depthTest:!1,depthWrite:!1,transparent:!0}),m=new d.Sprite(l);return m.scale.set(a,c,1),m}function me(e,t,r){const[[s,n],[a,c]]=B.geoBounds(e);if(isFinite(s)&&isFinite(n)&&Math.abs(s)<=180&&Math.abs(a)<=180&&Math.abs(n)<=90&&Math.abs(c)<=90){const i=B.geoMercator();return i.fitSize([t,r],e),i}else{const i=B.geoIdentity().reflectY(!0);return i.fitSize([t,r],e),i}}function he(){if(!w)return;const{innerWidth:e,innerHeight:t}=window;k=me(w,e,t);const r=le(w,k,e,t),s=ue(r),n=fe(w,k,e,t);T.clear(),T.add(s),T.add(n),pe(e,t),Se()}function pe(e,t){V.clear();const r=new Map(Object.entries(Y).map(([n,a])=>[o(n),a])),s=B.geoPath(k);for(const n of w.features){const a=J(n.properties);if(!a)continue;let c=o(a);G[c]&&(c=G[c]);const[f,i]=s.centroid(n),u=new d.Vector3(f-e/2,-i+t/2,0),l=se[c],m=r.get(c)||(l?r.get(l):void 0);m&&(u.set(m.x,m.y,0),m.scale!=null&&K.set(c,m.scale)),V.set(c,u)}}function ye(e){return Number.isFinite(e)?e<=50?["#a56c34",1e3]:e<=100?["#96ad2f",2500]:e<=200?["#3ba84d",5e3]:e<=300?["#1f6e2c",6e3]:["#325c49",7500]:["#555555",5e3]}const R=[[0,0,0,.16,0,0,.01],[.85,.04,-.04,.85,0,1.6,.85],[.2,-.26,.23,.22,0,1.6,.07],[-.15,.28,.26,.24,0,.44,.07]];function $(e){const[t,r]=ye(e),s=new d.Color(t),n=new Float32Array(r*3),a=new Float32Array(r*3);let c=0,f=0;const i=34,u=-40;for(let m=0;m<r;m++){const y=Math.random();let L,C,N,F,I,v;y<R[0][6]?[L,C,N,F,I,v]=R[0]:y<.86?[L,C,N,F,I,v]=R[1]:y<.93?[L,C,N,F,I,v]=R[2]:[L,C,N,F,I,v]=R[3];const Q=L*c+C*f+I,Z=N*c+F*f+v;c=Q,f=Z;const b=m*3;n[b+0]=c*i,n[b+1]=f*i+u,n[b+2]=0,a[b+0]=s.r,a[b+1]=s.g,a[b+2]=s.b}const l=new d.BufferGeometry;return l.setAttribute("position",new d.BufferAttribute(n,3)),l.setAttribute("color",new d.BufferAttribute(a,3)),l}function ge(e,t,r=.18){const s=$(e),n=new d.PointsMaterial({vertexColors:!0,size:.05}),a=new d.Points(s,n);return a.position.copy(t),a.scale.setScalar(r),a}function be(e,t){const r=e.geometry;e.geometry=$(t),r.dispose()}function we(e){const t=new Map;for(const s of e){const n=s.SUBDIVISION;n&&(t.has(n)||t.set(n,[]),t.get(n).push(s))}M=new Map;for(const[s,n]of t.entries())n.sort((a,c)=>Number(a[S])-Number(c[S])),M.set(s,n);U=Array.from(M.keys()).sort();const r=new Set;for(const s of M.values())for(const n of s){const a=Number(n[S]);Number.isFinite(a)&&r.add(a)}p=Array.from(r).sort((s,n)=>s-n),xe(),Ae(),Me(),H()}function q(e,t,r){const s=M.get(e);if(!s||s.length===0)return NaN;let n=s.find(a=>Number(a[S])===t);if(!n){for(let a=s.length-1;a>=0;a--)if(Number(s[a][S])<=t){n=s[a];break}n||(n=s[0])}return Number(n[r])}function Me(){for(;P.children.length;){const t=P.children.pop();t.geometry?.dispose(),t.material?.dispose()}g=[];let e=0;for(let t=0;t<U.length;t++){const r=U[t],s=G[o(r)]??o(r),n=p[O]??Number(M.get(r)?.[0]?.[S]),a=E[A],c=q(r,n,a),f=V.get(s),i=f?f.clone():new d.Vector3(0,0,0),u=K.get(s)??re;f||e++;const l=ge(c,i,u);l.userData.subdivision=r,l.userData.key=s,P.add(l),g.push(l)}e&&console.warn(`[buildAllFerns] ${e} ferns missing anchors (likely name mismatch).`)}function Se(){if(g.length)for(const e of g){const t=e.userData.key,r=V.get(t);r&&e.position.copy(r);const s=K.get(t);s!=null&&e.scale.setScalar(s)}}function H(){if(!g.length)return;const e=p[O],t=E[A];for(let r=0;r<g.length;r++){const s=U[r],n=g[r],a=q(s,e,t);be(n,a)}}function Ee(e){e-W>=oe&&p.length&&(W=e,A=(A+1)%E.length,H(),j())}function z(){const e=window.innerWidth,t=window.innerHeight;x.setSize(e,t,!1);const r=-e/2,s=e/2,n=t/2,a=-t/2;h?(h.left=r,h.right=s,h.top=n,h.bottom=a,h.updateProjectionMatrix()):(h=new d.OrthographicCamera(r,s,n,a,-1e3,1e3),h.position.set(0,0,10),h.lookAt(0,0,0)),he(),x.render(D,h),j()}function xe(){const e=document.getElementById("yearSelect");e&&(e.innerHTML="",p.forEach(t=>{const r=document.createElement("option");r.value=String(t),r.textContent=t,e.appendChild(r)}),O=Math.max(0,p.length-1),e.value=String(p[O]),e.addEventListener("change",()=>{const t=Number(e.value),r=p.indexOf(t);r!==-1&&(O=r,H(),j())}))}function Ae(){const e=document.getElementById("timelineBar"),t=document.getElementById("timelineLabels");!e||!t||(e.innerHTML="",t.innerHTML="",E.forEach((r,s)=>{const n=document.createElement("div");n.className="timeline-segment",n.style.borderRight=s<E.length-1?"1px solid rgba(255,255,255,0.25)":"none",n.style.background="rgba(255,255,255,0.08)",n.style.cursor="pointer",n.addEventListener("click",()=>{A=s,H(),j()}),e.appendChild(n);const a=document.createElement("div");a.textContent=r,t.appendChild(a)}),j())}function j(){const e=document.getElementById("timelineContainer"),t=document.getElementById("timelineIndicator");if(!e||!t)return;const s=e.clientWidth/E.length,n=s*A+s/2;t.style.left=`${Math.round(n)}px`}(async function(){try{w=await ae(_)}catch(t){console.error(t);const r=document.getElementById("hud");r.innerHTML="Failed to load <code>"+_+"</code>. Make sure a dev server is running and the file exists.";return}try{const t=await ie(te);we(t)}catch(t){console.error("CSV load error:",t)}window.addEventListener("resize",z),z(),X()})();function X(e=0){requestAnimationFrame(X),Ee(e),x.render(D,h)}
